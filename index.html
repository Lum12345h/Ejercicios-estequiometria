<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicios de Estequiometría</title>
    <style>
      /* Estilos Generales */
      body {
        font-family: sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #eef2f7; /* Slightly different background */
        color: #333;
        display: flex;
        justify-content: center;
        min-height: 100vh; /* Ensure container can center vertically if needed */
      }

      .container {
        width: 100%;
        max-width: 800px; /* Max width for content */
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin: 20px 0; /* Add vertical margin */
      }

      h1,
      h2 {
        color: #1a5276; /* Darker blue */
        border-bottom: 2px solid #5dade2; /* Lighter blue accent */
        padding-bottom: 10px;
        margin-bottom: 25px;
        text-align: center;
      }

      h2 {
        margin-top: 40px; /* Space between sections */
        border-bottom: 1px dashed #aed6f1;
        color: #1f618d;
        text-align: left; /* Align section headers left */
      }

      /* Estilo para el botón de navegación a Balanceo */
      .nav-button-container {
        text-align: center; /* Centra el botón */
        margin-bottom: 35px; /* Más espacio debajo del botón */
        margin-top: -10px; /* Acercarlo un poco al título */
      }

      .nav-button {
        display: inline-block; /* Permite aplicar padding y centrado */
        background-color: #e67e22; /* Un color naranja llamativo */
        color: white;
        padding: 12px 25px; /* Más padding para destacar */
        border: none;
        border-radius: 5px;
        font-size: 1.1em; /* Un poco más grande */
        font-weight: bold;
        text-decoration: none; /* Quita el subrayado del enlace */
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease,
          box-shadow 0.2s ease;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
      }
      .nav-button:hover {
        background-color: #d35400; /* Naranja más oscuro al pasar el mouse */
        transform: translateY(-2px); /* Efecto ligero de elevación */
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      }
      .nav-button:active {
        transform: translateY(0); /* Vuelve a su posición al hacer clic */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      /* Secciones de Ejercicios */
      .ejercicio-seccion {
        margin-bottom: 30px;
        padding: 25px;
        border: 1px solid #d6eaf8; /* Lighter border */
        border-radius: 6px;
        background-color: #f8f9fa; /* Very light grey */
        position: relative; /* For potential absolute elements if needed later */
      }

      /* Formularios y Entradas */
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
        color: #2e4053;
        font-size: 0.95em;
      }
      label.respuesta-label {
        display: inline-block; /* Keep answer label inline */
        margin-right: 8px;
        margin-bottom: 0; /* Remove bottom margin for inline */
        vertical-align: middle; /* Align with input */
      }

      input[type="number"],
      textarea {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 18px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 1em;
        background-color: #fff;
      }
      /* Smaller width for answer input */
      input.respuesta-usuario {
        width: 150px;
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 18px; /* Keep consistent margin */
        vertical-align: middle;
      }

      textarea {
        height: 80px; /* Default height */
        resize: vertical;
        font-family: monospace; /* Good for procedures */
        color: #555;
        background-color: #fdfefe; /* Slightly off-white */
      }

      button {
        background-color: #3498db;
        color: white;
        padding: 10px 18px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95em;
        transition: background-color 0.3s ease, box-shadow 0.2s ease;
        margin-right: 10px;
        margin-top: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      button:hover {
        background-color: #2980b9;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      button.secondary {
        background-color: #7f8c8d;
      }
      button.secondary:hover {
        background-color: #626f70; /* Darker grey */
      }

      /* Ecuaciones Químicas */
      .equation {
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        margin: 15px 0 20px 0; /* More bottom margin */
        padding: 12px;
        background-color: #eaf2f8; /* Light blue background */
        border-left: 5px solid #5dade2;
        border-radius: 4px;
        color: #1a5276;
        font-family: "Courier New", Courier, monospace; /* Monospace for better formula alignment */
        overflow-x: auto; /* Handle long equations on small screens */
      }

      /* Resultados y Feedback */
      .feedback {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        font-weight: 500; /* Slightly less bold */
        min-height: 40px;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        color: #495057;
        line-height: 1.5; /* Better readability for procedures */
      }

      .feedback.incorrecto {
        color: #721c24; /* Darker red */
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .feedback.correcto {
        color: #155724; /* Darker green */
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .feedback strong {
        /* Style correct answer within feedback */
        color: #1f618d; /* Match heading color */
        font-weight: bold;
      }
      .feedback .procedimiento-titulo {
        /* Style procedure heading */
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 5px;
        display: block;
        color: #555;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .feedback .procedimiento-pasos {
        /* Style steps */
        font-family: monospace;
        font-size: 0.95em;
        color: #333;
        white-space: pre-wrap; /* Preserve line breaks in procedure */
        background-color: rgba(
          255,
          255,
          255,
          0.6
        ); /* Slight white background for steps */
        padding: 10px;
        border-radius: 3px;
        border-left: 3px solid #adb5bd;
      }

      /* Notas y Problemas */
      .problema-texto {
        font-size: 1.05em;
        color: #34495e;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #fdfefe;
        border-left: 4px solid #5dade2;
        font-weight: 500;
        border-radius: 3px;
      }
      .notes {
        font-size: 0.9em;
        color: #7f8c8d;
        margin-top: -10px; /* Pull closer to element above */
        margin-bottom: 15px; /* Space before next element */
        padding-left: 10px;
      }
      .label-note {
        font-size: 0.85em;
        font-weight: normal;
        color: #666;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ejercicios de Estequiometría</h1>

      <!-- =========== BOTÓN DE NAVEGACIÓN A BALANCEO ========== -->
      <div class="nav-button-container">
        <a href="./balanceoaltanteo.html" class="nav-button">
          ¿Necesitas Practicar Balanceo? ¡Haz Clic Aquí!
        </a>
      </div>
      <!-- ===================================================== -->

      <!-- Ejercicio: Mol-Mol -->
      <section class="ejercicio-seccion" id="ejercicio-mol-mol">
        <h2>Práctica: Mol-Mol</h2>
        <div class="problema-container">
          <p class="problema-texto" id="problema-mol-mol-texto">
            Presiona "Generar Nuevo Problema" para empezar.
          </p>
          <div class="equation" id="ecuacion-mol-mol">Ecuación aquí...</div>
        </div>
        <div class="interaccion-container">
          <label for="proc-mol-mol">
            Tu Procedimiento
            <span class="label-note">(Opcional - solo apoyo)</span>
          </label>
          <textarea
            id="proc-mol-mol"
            placeholder="Puedes escribir tus pasos aquí si te ayuda..."
          ></textarea>

          <label for="resp-mol-mol" class="respuesta-label"
            >Tu Respuesta (moles):</label
          >
          <input
            type="number"
            id="resp-mol-mol"
            class="respuesta-usuario"
            step="any"
            placeholder="Valor numérico"
          />

          <button onclick="chequearRespuesta('mol-mol')">
            Comprobar Respuesta
          </button>
          <button onclick="generarProblema('mol-mol')" class="secondary">
            Generar Nuevo Problema
          </button>

          <div class="feedback" id="feedback-mol-mol"></div>
        </div>
      </section>

      <!-- Ejercicio: Masa-Masa -->
      <section class="ejercicio-seccion" id="ejercicio-masa-masa">
        <h2>Práctica: Masa-Masa</h2>
        <div class="problema-container">
          <p class="problema-texto" id="problema-masa-masa-texto">
            Presiona "Generar Nuevo Problema" para empezar.
          </p>
          <div class="equation" id="ecuacion-masa-masa">Ecuación aquí...</div>
          <div class="notes" id="masas-molares-masa-masa">
            Masas Molares: ...
          </div>
        </div>
        <div class="interaccion-container">
          <label for="proc-masa-masa">
            Tu Procedimiento
            <span class="label-note">(Opcional - solo apoyo)</span>
          </label>
          <textarea
            id="proc-masa-masa"
            placeholder="Puedes escribir tus pasos aquí si te ayuda..."
          ></textarea>

          <label for="resp-masa-masa" class="respuesta-label"
            >Tu Respuesta (gramos):</label
          >
          <input
            type="number"
            id="resp-masa-masa"
            class="respuesta-usuario"
            step="any"
            placeholder="Valor numérico"
          />

          <button onclick="chequearRespuesta('masa-masa')">
            Comprobar Respuesta
          </button>
          <button onclick="generarProblema('masa-masa')" class="secondary">
            Generar Nuevo Problema
          </button>

          <div class="feedback" id="feedback-masa-masa"></div>
        </div>
      </section>

      <!-- Ejercicio: Masa-Volumen -->
      <section class="ejercicio-seccion" id="ejercicio-masa-volumen">
        <h2>Práctica: Masa-Volumen (Gas en CNPT)</h2>
        <div class="problema-container">
          <p class="problema-texto" id="problema-masa-volumen-texto">
            Presiona "Generar Nuevo Problema" para empezar.
          </p>
          <div class="equation" id="ecuacion-masa-volumen">
            Ecuación aquí...
          </div>
          <div class="notes" id="masas-molares-masa-volumen">
            Masas Molares: ...
          </div>
        </div>
        <div class="interaccion-container">
          <label for="proc-masa-volumen">
            Tu Procedimiento
            <span class="label-note">(Opcional - solo apoyo)</span>
          </label>
          <textarea
            id="proc-masa-volumen"
            placeholder="Puedes escribir tus pasos aquí si te ayuda..."
          ></textarea>

          <label for="resp-masa-volumen" class="respuesta-label"
            >Tu Respuesta (Litros en CNPT):</label
          >
          <input
            type="number"
            id="resp-masa-volumen"
            class="respuesta-usuario"
            step="any"
            placeholder="Valor numérico"
          />

          <button onclick="chequearRespuesta('masa-volumen')">
            Comprobar Respuesta
          </button>
          <button onclick="generarProblema('masa-volumen')" class="secondary">
            Generar Nuevo Problema
          </button>

          <div class="feedback" id="feedback-masa-volumen"></div>
          <p class="notes">
            Recuerda: 1 mol de gas ideal ocupa 22.4 L en CNPT (0°C y 1 atm).
          </p>
        </div>
      </section>
    </div>

    <script>
      const VOLUMEN_MOLAR_CNPT = 22.4; // L/mol
      const TOLERANCIA = 0.025; // Tolerancia relativa del 2.5%

      // =============================================
      // DATOS PARA EJERCICIOS ALEATORIOS (CORREGIDOS Y CON CLAVES SEGURAS)
      // =============================================
      const dataMolMol = [
        {
          eq: "2 H₂ (g) + O₂ (g) → 2 H₂O (l)",
          coef: { H2: 2, O2: 1, H2O: 2 },
          known: "H2",
          unknown: "H2O",
          prompt:
            "Si reaccionan {value} moles de H₂, ¿cuántos moles de H₂O se producen?",
        },
        {
          eq: "N₂ (g) + 3 H₂ (g) → 2 NH₃ (g)",
          coef: { N2: 1, H2: 3, NH3: 2 },
          known: "N2",
          unknown: "NH3",
          prompt:
            "A partir de {value} moles de N₂, ¿cuántos moles de NH₃ se forman?",
        },
        {
          eq: "2 SO₂ (g) + O₂ (g) → 2 SO₃ (g)",
          coef: { SO2: 2, O2: 1, SO3: 2 },
          known: "O2",
          unknown: "SO3",
          prompt:
            "Si se consumen {value} moles de O₂, ¿cuántos moles de SO₃ se generan?",
        },
        {
          eq: "Fe₂O₃ (s) + 3 CO (g) → 2 Fe (s) + 3 CO₂ (g)",
          coef: { Fe2O3: 1, CO: 3, Fe: 2, CO2: 3 },
          known: "CO",
          unknown: "Fe",
          prompt: "Con {value} moles de CO, ¿cuántos moles de Fe se obtienen?",
        },
        {
          eq: "C₃H₈ (g) + 5 O₂ (g) → 3 CO₂ (g) + 4 H₂O (l)",
          coef: { C3H8: 1, O2: 5, CO2: 3, H2O: 4 },
          known: "C3H8",
          unknown: "CO2",
          prompt:
            "Al quemar {value} moles de C₃H₈, ¿cuántos moles de CO₂ se producen?",
        },
      ];

      const dataMasaMasa = [
        {
          eq: "CH₄ (g) + 2 O₂ (g) → CO₂ (g) + 2 H₂O (l)",
          coef: { CH4: 1, O2: 2, CO2: 1, H2O: 2 },
          masses: { CH4: 16.04, O2: 32.0, CO2: 44.01, H2O: 18.02 },
          known: "CH4",
          unknown: "CO2",
          prompt:
            "Si se queman {value} gramos de CH₄, ¿cuántos gramos de CO₂ se producen?",
        },
        {
          eq: "2 KClO₃ (s) → 2 KCl (s) + 3 O₂ (g)",
          coef: { KClO3: 2, KCl: 2, O2: 3 },
          masses: { KClO3: 122.55, KCl: 74.55, O2: 32.0 },
          known: "KClO3",
          unknown: "KCl",
          prompt:
            "Al descomponer {value} gramos de KClO₃, ¿cuántos gramos de KCl se forman?",
        },
        {
          eq: "Fe₂O₃ (s) + 3 CO (g) → 2 Fe (s) + 3 CO₂ (g)",
          coef: { Fe2O3: 1, CO: 3, Fe: 2, CO2: 3 },
          masses: { Fe2O3: 159.69, CO: 28.01, Fe: 55.85, CO2: 44.01 },
          known: "Fe2O3",
          unknown: "Fe",
          prompt:
            "Si reaccionan {value} gramos de Fe₂O₃, ¿cuántos gramos de Fe se obtienen?",
        },
        {
          eq: "Mg (s) + 2 HCl (aq) → MgCl₂ (aq) + H₂ (g)",
          coef: { Mg: 1, HCl: 2, MgCl2: 1, H2: 1 },
          masses: { Mg: 24.31, HCl: 36.46, MgCl2: 95.21, H2: 2.02 },
          known: "Mg",
          unknown: "MgCl2",
          prompt:
            "Si reaccionan {value} gramos de Mg con suficiente HCl, ¿cuántos gramos de MgCl₂ se producen?",
        },
      ];

      const dataMasaVolumen = [
        {
          eq: "2 KClO₃ (s) → 2 KCl (s) + 3 O₂ (g)",
          coef: { KClO3: 2, KCl: 2, O2: 3 },
          masses: { KClO3: 122.55, KCl: 74.55, O2: 32.0 },
          known: "KClO3",
          unknown: "O2",
          prompt:
            "Al descomponer {value} gramos de KClO₃, ¿cuántos litros de O₂ gaseoso se producen en CNPT?",
        },
        {
          eq: "Zn (s) + 2 HCl (aq) → ZnCl₂ (aq) + H₂ (g)",
          coef: { Zn: 1, HCl: 2, ZnCl2: 1, H2: 1 },
          masses: { Zn: 65.38, HCl: 36.46, ZnCl2: 136.28, H2: 2.02 },
          known: "Zn",
          unknown: "H2",
          prompt:
            "Si reaccionan {value} gramos de Zn, ¿cuántos litros de H₂ gaseoso se miden en CNPT?",
        },
        {
          eq: "CaCO₃ (s) → CaO (s) + CO₂ (g)",
          coef: { CaCO3: 1, CaO: 1, CO2: 1 },
          masses: { CaCO3: 100.09, CaO: 56.08, CO2: 44.01 },
          known: "CaCO3",
          unknown: "CO2",
          prompt:
            "Al calentar {value} gramos de CaCO₃, ¿qué volumen de CO₂ (en litros) se desprende en CNPT?",
        },
        // *** NOTA: Corregida ecuación de H2O2 que estaba mal balanceada en el ejemplo del usuario ***
        {
          eq: "2 H₂O₂ (aq) → 2 H₂O (l) + O₂ (g)",
          coef: { H2O2: 2, H2O: 2, O2: 1 },
          masses: { H2O2: 34.01, H2O: 18.02, O2: 32.0 },
          known: "H2O2",
          unknown: "O2",
          prompt:
            "La descomposición de {value} gramos de H₂O₂ produce ¿cuántos litros de O₂ medidos en CNPT?",
        },
      ];

      // Almacena la respuesta correcta Y el procedimiento para cada sección
      let problemasActuales = {
        "mol-mol": null,
        "masa-masa": null,
        "masa-volumen": null,
      };

      // =============================================
      //         FUNCIONES PARA EJERCICIOS
      // =============================================

      function getRandomValue(min, max, decimals = 1) {
        const factor = Math.pow(10, decimals);
        return parseFloat(
          (Math.random() * (max - min) + min).toFixed(decimals)
        );
      }

      // ****** INICIO FUNCIÓN GENERARPROBLEMA MODIFICADA ******
      function generarProblema(tipo) {
        let dataSet,
          valorInput,
          unidadInput,
          unidadOutput,
          problemaTextoEl,
          ecuacionEl,
          feedbackEl,
          respuestaInputEl,
          procTextareaEl,
          masasMolaresEl;
        let problemaData,
          knownSubstance,
          unknownSubstance,
          knownCoeff,
          unknownCoeff;
        let respuestaCorrectaNum;
        let procedimientoCorrectoStr = ""; // Variable para guardar el procedimiento

        // Selectors and data based on type
        if (tipo === "mol-mol") {
          // --- Sección Mol-Mol con procedimiento según descripción del usuario ---
          dataSet = dataMolMol;
          valorInput = getRandomValue(0.5, 20, 2); // Moles
          unidadInput = "moles";
          unidadOutput = "moles";
          problemaTextoEl = document.getElementById("problema-mol-mol-texto");
          ecuacionEl = document.getElementById("ecuacion-mol-mol");
          feedbackEl = document.getElementById("feedback-mol-mol");
          respuestaInputEl = document.getElementById("resp-mol-mol");
          procTextareaEl = document.getElementById("proc-mol-mol");
          masasMolaresEl = null;

          problemaData = dataSet[Math.floor(Math.random() * dataSet.length)];
          knownSubstance = problemaData.known;
          unknownSubstance = problemaData.unknown;
          knownCoeff = problemaData.coef[knownSubstance];
          unknownCoeff = problemaData.coef[unknownSubstance];

          // Calcular respuesta
          respuestaCorrectaNum = valorInput * (unknownCoeff / knownCoeff);

          // Generar procedimiento Mol-Mol según descripción
          procedimientoCorrectoStr = `1. Verificar que la ecuación esté balanceada (¡ya lo está!).\n`;
          procedimientoCorrectoStr += `2. Estructurar datos dados y deseados:\n`;
          procedimientoCorrectoStr += `   - Dados: ${valorInput.toFixed(
            2
          )} moles de ${knownSubstance} (Coeficiente en ecuación: ${knownCoeff})\n`;
          procedimientoCorrectoStr += `   - Deseados: X moles de ${unknownSubstance} (Coeficiente en ecuación: ${unknownCoeff})\n`;
          procedimientoCorrectoStr += `3. Plantear el problema usando el factor mol-mol (relación de coeficientes) para cancelar los moles dados:\n`;
          procedimientoCorrectoStr += `   Factor mol-mol = (${unknownCoeff} moles de ${unknownSubstance} / ${knownCoeff} moles de ${knownSubstance})\n`;
          procedimientoCorrectoStr += `   Cálculo: ${valorInput.toFixed(
            2
          )} moles de ${knownSubstance} * (${unknownCoeff} moles de ${unknownSubstance} / ${knownCoeff} moles de ${knownSubstance})\n`;
          procedimientoCorrectoStr += `   Resultado = ${respuestaCorrectaNum.toFixed(
            3
          )} moles de ${unknownSubstance}`; // Más precisión interna para el cálculo
        } else if (tipo === "masa-masa") {
          // --- Sección Masa-Masa con procedimiento de Regla de 3 ---
          dataSet = dataMasaMasa;
          valorInput = getRandomValue(1, 250, 1); // Grams
          unidadInput = "gramos";
          unidadOutput = "gramos";
          problemaTextoEl = document.getElementById("problema-masa-masa-texto");
          ecuacionEl = document.getElementById("ecuacion-masa-masa");
          masasMolaresEl = document.getElementById("masas-molares-masa-masa");
          feedbackEl = document.getElementById("feedback-masa-masa");
          respuestaInputEl = document.getElementById("resp-masa-masa");
          procTextareaEl = document.getElementById("proc-masa-masa");

          problemaData = dataSet[Math.floor(Math.random() * dataSet.length)];
          knownSubstance = problemaData.known;
          unknownSubstance = problemaData.unknown;
          knownCoeff = problemaData.coef[knownSubstance];
          unknownCoeff = problemaData.coef[unknownSubstance];
          const knownMolarMass = problemaData.masses[knownSubstance];
          const unknownMolarMass = problemaData.masses[unknownSubstance];

          // Calcular la respuesta (internamente seguimos usando moles por precisión)
          const molesKnown = valorInput / knownMolarMass;
          const molesUnknown = molesKnown * (unknownCoeff / knownCoeff);
          respuestaCorrectaNum = molesUnknown * unknownMolarMass;

          // Generar procedimiento según la "Regla de 3" directa con masas
          const totalMasaConocidaEq = knownCoeff * knownMolarMass; // Masa total de la sustancia conocida en la ecuación balanceada
          const totalMasaDesconocidaEq = unknownCoeff * unknownMolarMass; // Masa total de la sustancia desconocida en la ecuación balanceada

          procedimientoCorrectoStr = `1. Verificar que la ecuación esté balanceada (¡ya lo está!).\n`;
          procedimientoCorrectoStr += `2. Calcular/Identificar las masas molares necesarias:\n`;
          procedimientoCorrectoStr += `   - Masa Molar ${knownSubstance}: ${knownMolarMass.toFixed(
            2
          )} g/mol\n`;
          procedimientoCorrectoStr += `   - Masa Molar ${unknownSubstance}: ${unknownMolarMass.toFixed(
            2
          )} g/mol\n`;
          procedimientoCorrectoStr += `3. Establecer la relación de masas según la ecuación balanceada:\n`;
          procedimientoCorrectoStr += `   - Masa de ${knownSubstance} en la ecuación = ${knownCoeff} mol * ${knownMolarMass.toFixed(
            2
          )} g/mol = ${totalMasaConocidaEq.toFixed(2)} g\n`;
          procedimientoCorrectoStr += `   - Masa de ${unknownSubstance} en la ecuación = ${unknownCoeff} mol * ${unknownMolarMass.toFixed(
            2
          )} g/mol = ${totalMasaDesconocidaEq.toFixed(2)} g\n`;
          procedimientoCorrectoStr += `   Esto significa: ${totalMasaConocidaEq.toFixed(
            2
          )} g de ${knownSubstance} producen/reaccionan con ${totalMasaDesconocidaEq.toFixed(
            2
          )} g de ${unknownSubstance}.\n`;
          procedimientoCorrectoStr += `4. Aplicar la Regla de 3 con la masa dada (${valorInput.toFixed(
            1
          )} g de ${knownSubstance}):\n`;
          procedimientoCorrectoStr += `      ${totalMasaConocidaEq.toFixed(
            2
          )} g ${knownSubstance}   ---->   ${totalMasaDesconocidaEq.toFixed(
            2
          )} g ${unknownSubstance}\n`;
          procedimientoCorrectoStr += `      ${valorInput.toFixed(
            1
          )} g ${knownSubstance}   ---->   X g ${unknownSubstance}\n\n`;
          procedimientoCorrectoStr += `   Resolviendo para X:\n`;
          procedimientoCorrectoStr += `   X = (${valorInput.toFixed(
            1
          )} g ${knownSubstance} * ${totalMasaDesconocidaEq.toFixed(
            2
          )} g ${unknownSubstance}) / ${totalMasaConocidaEq.toFixed(
            2
          )} g ${knownSubstance}\n`;
          procedimientoCorrectoStr += `   X = ${respuestaCorrectaNum.toFixed(
            2
          )} g ${unknownSubstance}`;

          masasMolaresEl.textContent = `Masas Molares Necesarias: ${knownSubstance} ≈ ${knownMolarMass.toFixed(
            2
          )} g/mol, ${unknownSubstance} ≈ ${unknownMolarMass.toFixed(2)} g/mol`;
        } else if (tipo === "masa-volumen") {
          // --- Sección Masa-Volumen con procedimiento según descripción del usuario ---
          dataSet = dataMasaVolumen;
          valorInput = getRandomValue(1, 100, 1); // Grams
          unidadInput = "gramos";
          unidadOutput = "Litros (CNPT)";
          problemaTextoEl = document.getElementById(
            "problema-masa-volumen-texto"
          );
          ecuacionEl = document.getElementById("ecuacion-masa-volumen");
          masasMolaresEl = document.getElementById(
            "masas-molares-masa-volumen"
          );
          feedbackEl = document.getElementById("feedback-masa-volumen");
          respuestaInputEl = document.getElementById("resp-masa-volumen");
          procTextareaEl = document.getElementById("proc-masa-volumen");

          problemaData = dataSet[Math.floor(Math.random() * dataSet.length)];
          knownSubstance = problemaData.known; // La sustancia de la que se da la masa
          unknownSubstance = problemaData.unknown; // El gas del que se pide volumen
          knownCoeff = problemaData.coef[knownSubstance];
          unknownCoeff = problemaData.coef[unknownSubstance];
          const knownMolarMass = problemaData.masses[knownSubstance];

          // Calcular respuesta (paso a paso internamente)
          const molesKnown = valorInput / knownMolarMass;
          const molesUnknownGas = molesKnown * (unknownCoeff / knownCoeff); // Moles del GAS
          respuestaCorrectaNum = molesUnknownGas * VOLUMEN_MOLAR_CNPT;

          // Generar procedimiento Masa-Volumen según descripción
          procedimientoCorrectoStr = `1. Verificar que la ecuación esté balanceada (¡ya lo está!).\n`;
          procedimientoCorrectoStr += `2. Escribir datos dados y deseados:\n`;
          procedimientoCorrectoStr += `   - Dados: ${valorInput.toFixed(
            1
          )} g de ${knownSubstance}\n`;
          procedimientoCorrectoStr += `   - Deseados: X Litros de ${unknownSubstance} (en CNPT)\n`;
          procedimientoCorrectoStr += `3. Obtener la Masa Molar de la sustancia dada (${knownSubstance}):\n`;
          procedimientoCorrectoStr += `   - Masa Molar ${knownSubstance} = ${knownMolarMass.toFixed(
            2
          )} g/mol\n`;
          procedimientoCorrectoStr += `4. Calcular los moles de la sustancia dada (${knownSubstance}) usando n = m / PM:\n`;
          procedimientoCorrectoStr += `   n (${knownSubstance}) = ${valorInput.toFixed(
            1
          )} g / ${knownMolarMass.toFixed(2)} g/mol = ${molesKnown.toFixed(
            4
          )} mol\n`;
          procedimientoCorrectoStr += `5. Usar la relación molar de la ecuación (${knownCoeff} mol ${knownSubstance} : ${unknownCoeff} mol ${unknownSubstance}) para calcular los moles del gas (${unknownSubstance}):\n`;
          procedimientoCorrectoStr += `   n (${unknownSubstance}) = ${molesKnown.toFixed(
            4
          )} mol ${knownSubstance} * (${unknownCoeff} mol ${unknownSubstance} / ${knownCoeff} mol ${knownSubstance}) = ${molesUnknownGas.toFixed(
            4
          )} mol\n`;
          procedimientoCorrectoStr += `6. Convertir los moles del gas (${unknownSubstance}) a Litros en CNPT (1 mol = ${VOLUMEN_MOLAR_CNPT} L):\n`;
          procedimientoCorrectoStr += `   Volumen ${unknownSubstance} = ${molesUnknownGas.toFixed(
            4
          )} mol * ${VOLUMEN_MOLAR_CNPT} L/mol\n`;
          procedimientoCorrectoStr += `   Volumen ${unknownSubstance} = ${respuestaCorrectaNum.toFixed(
            2
          )} L`;

          masasMolaresEl.textContent = `Masa Molar Necesaria: ${knownSubstance} ≈ ${knownMolarMass.toFixed(
            2
          )} g/mol`;
        } else {
          console.error("Tipo de problema desconocido:", tipo);
          return;
        }

        // Actualizar UI
        const prompt = problemaData.prompt.replace(
          "{value}",
          valorInput.toString()
        );
        problemaTextoEl.textContent = prompt;
        ecuacionEl.textContent = problemaData.eq;
        feedbackEl.innerHTML = ""; // Clear feedback content
        feedbackEl.className = "feedback"; // Reset class
        respuestaInputEl.value = "";
        procTextareaEl.value = "";

        // Store correct answer AND procedure
        problemasActuales[tipo] = {
          valor: respuestaCorrectaNum,
          procedimiento: procedimientoCorrectoStr,
          unidad: unidadOutput, // Store unit for feedback message
        };
      }
      // ****** FIN FUNCIÓN GENERARPROBLEMA MODIFICADA ******

      function chequearRespuesta(tipo) {
        const respuestaInputEl = document.getElementById(`resp-${tipo}`);
        const feedbackEl = document.getElementById(`feedback-${tipo}`);
        const problemaActual = problemasActuales[tipo]; // Retrieve stored problem data

        feedbackEl.innerHTML = ""; // Clear previous feedback (use innerHTML now)
        feedbackEl.className = "feedback"; // Reset class

        if (!problemaActual) {
          feedbackEl.textContent = "Primero genera un problema.";
          feedbackEl.classList.add("incorrecto");
          return;
        }

        const respuestaCorrecta = problemaActual.valor;
        const procedimientoCorrecto = problemaActual.procedimiento;
        const unidad = problemaActual.unidad;

        const respuestaUsuario = parseFloat(respuestaInputEl.value);

        if (isNaN(respuestaUsuario)) {
          feedbackEl.textContent = "Por favor, ingresa una respuesta numérica.";
          feedbackEl.classList.add("incorrecto");
          return;
        }

        // Check with tolerance
        const diff = Math.abs(respuestaUsuario - respuestaCorrecta);
        // Use relative tolerance OR a small absolute tolerance for near-zero answers
        const limiteTolerancia = Math.max(
          Math.abs(respuestaCorrecta * TOLERANCIA),
          0.01
        );

        if (diff <= limiteTolerancia) {
          feedbackEl.textContent = `¡Correcto! La respuesta es aproximadamente ${respuestaCorrecta.toFixed(
            2
          )} ${unidad}.`;
          feedbackEl.classList.add("correcto");
        } else {
          // Use innerHTML to format the procedure nicely
          feedbackEl.innerHTML =
            `Incorrecto. <br>` +
            `La respuesta correcta es: <strong>${respuestaCorrecta.toFixed(
              2
            )} ${unidad}</strong>.<br>` +
            `<span class="procedimiento-titulo">Procedimiento:</span>` +
            `<div class="procedimiento-pasos">${procedimientoCorrecto.replace(
              /\n/g,
              "<br>"
            )}</div>`; // Replace newlines with <br> for HTML display
          feedbackEl.classList.add("incorrecto");
        }
      }

      // --- Initialize by generating first problems on load ---
      document.addEventListener("DOMContentLoaded", () => {
        generarProblema("mol-mol");
        generarProblema("masa-masa");
        generarProblema("masa-volumen");
      });
    </script>
  </body>
</html>
